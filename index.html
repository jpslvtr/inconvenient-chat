<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>inconvenient-chat</title>
    <script src="https://unpkg.com/openpgp@5.11.0/dist/openpgp.min.js"></script>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyBvyMBJx1ARbgS41wco-GqZX6tbMb6OAGs",
            authDomain: "inconvenient-chat.firebaseapp.com",
            projectId: "inconvenient-chat",
            storageBucket: "inconvenient-chat.firebasestorage.app",
            messagingSenderId: "1028515558620",
            appId: "1:1028515558620:web:6c6f3ff593fb8bf3a7b019",
            measurementId: "G-LV0QKQL6Q2"
        };

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, arrayUnion, increment } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.firestoreLoaded = true;

        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.onSnapshot = onSnapshot;
        window.arrayUnion = arrayUnion;
        window.increment = increment;
    </script>

    <link rel="stylesheet" href="styles.css">

</head>

<body>
    <div class="container">
        <h1>inconvenient-chat</h1>

        <div id="roomSelection" class="room-selection">
            <h2>Create or Join Chat Room</h2>
        
            <div class="privacy-info">
                <h3>How it works:</h3>
                <p><strong>Setup:</strong> Configure your keys once, then chat seamlessly</p>
                <p><strong>Privacy:</strong> All encryption happens in your browser - keys are saved locally for this session
                </p>
                <p><strong>Database storage:</strong> Only encrypted messages are stored on the server to maintain chat history across
                    sessions. Your private keys and decrypted messages never leave your browser. Message decryption and viewing happens
                    entirely on your device.</p>
            </div>
        
            <div class="room-input">
                <button onclick="createRoom()">Create New Room</button>
                <span>or</span>
                <input type="text" id="joinRoomCode" placeholder="Enter 6-digit room code" maxlength="6">
                <button onclick="joinRoom()">Join Room</button>
            </div>
            <div id="roomStatus"></div>
        </div>

        <div id="chatInterface" class="hidden">
            <div class="instructions">
                <strong>Room Code: <span id="currentRoomCode"></span></strong> (share this with your contacts)<br>
                <strong>Ready to chat</strong>! Messages are secure and private
            </div>

            <div class="chat-area">
                <h2>Chat Messages <span id="messageStatus" class="loading"></span></h2>
                <div id="messages" class="messages">
                    <div style="color: #808080; font-style: italic; text-align: center; margin-top: 50px;">
                        Complete setup below to start chatting
                    </div>
                </div>
                <div>
                    <textarea id="newMessage" class="message-input" placeholder="Type your message here..." rows="3"
                        disabled></textarea>
                    <button id="sendButton" onclick="sendMessage()" disabled>Send Message</button>
                    <button onclick="leaveRoom()">Leave Room</button>
                </div>
            </div>

            <div id="setupSection">
                <div class="panels">
                    <div class="panel">
                        <h2>Setup Your Identity</h2>

                        <div id="setupForm">
                            <label>Your Name:</label>
                            <input type="text" id="myName" placeholder="Your name in this room">

                            <label>Your Public Key:</label>
                            <textarea id="myPublicKey" class="key-input"
                                placeholder="-----BEGIN PGP PUBLIC KEY BLOCK-----&#10;&#10;your public key&#10;&#10;-----END PGP PUBLIC KEY BLOCK-----"></textarea>

                            <label>Your Private Key:</label>
                            <textarea id="myPrivateKey" class="key-input"
                                placeholder="-----BEGIN PGP PRIVATE KEY BLOCK-----&#10;&#10;your private key&#10;&#10;-----END PGP PRIVATE KEY BLOCK-----"></textarea>

                            <label>Passphrase (if any):</label>
                            <input type="password" id="myPassphrase"
                                placeholder="Private key passphrase (leave blank if none)">

                            <button onclick="setupIdentity()">Setup Identity & Join Room</button>
                            <div id="setupStatus"></div>
                        </div>

                        <div id="setupComplete" class="setup-complete hidden">
                            <span><strong>Setup Complete!</strong> You're chatting as <span
                                    id="displayName"></span></span>
                            <button onclick="editIdentity()">Edit Keys</button>
                        </div>
                    </div>

                    <div class="panel">
                        <h2>Room Participants</h2>

                        <div style="margin-bottom: 15px;">
                            <label>Add Participant:</label>
                            <input type="text" id="participantName" placeholder="Participant name (e.g., Alice, Bob)">
                            <textarea id="newParticipantKey" class="key-input"
                                placeholder="-----BEGIN PGP PUBLIC KEY BLOCK-----&#10;&#10;participant's public key&#10;&#10;-----END PGP PUBLIC KEY BLOCK-----"></textarea>
                            <button onclick="addParticipant()">Add to Room</button>
                        </div>

                        <div
                            style="border: 1px solid #999; max-height: 200px; overflow-y: auto; padding: 8px; background-color: white;">
                            <div id="participantsList" style="font-size: 12px;">
                                <div style="color: #666; font-style: italic;">No participants yet</div>
                            </div>
                        </div>

                        <div id="participantsStatus"></div>

                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            Â© 2025 James Park
        </div>
    </div>
    <script src="script.js"></script>
</body>

</html>